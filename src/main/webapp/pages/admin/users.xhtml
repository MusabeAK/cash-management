<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/pages/template/template.xhtml">
    <ui:define name="content" class="form-container">
        <f:event type="preRenderComponent" listener="#{navigationBean.updateActivePage}" />

        <h:panelGroup layout="block" styleClass="top-bar">
            <span class="menu-icon" onclick="toggleNav()">&#9776;</span>
            <h:outputText value="Users" styleClass="top-bar-title" />
        </h:panelGroup>

        <div class="content">
            <h:form id="usersForm">
<!--                <p:growl id="growl" showDetail="true" life="2000"  />-->
                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true"
                                 width="350">
                    <p:commandButton value="No" type="button"
                                     styleClass="ui-confirmdialog-no ui-button-flat"/>
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" update=":usersForm"/>
                </p:confirmDialog>

                <div class="cards-container">
                    <div class="card">
                        <i class="pi pi-key card-icon"/>
                        <div class="card-content">
                            <h:outputText value="Total Amount Disbursed" styleClass="card-title"/>
                            <h:outputText value="20" styleClass="card-number"/>
                        </div>
                    </div>
                    <div class="card">
                        <i class="pi pi-key card-icon"/>
                        <div class="card-content">
                            <h:outputText value="Number of Registered Users" styleClass="card-title"/>
                            <h:outputText value="30" styleClass="card-number"/>
                        </div>
                    </div>

                    <div class="card">
                        <i class="pi pi-users card-icon"/>
                        <div class="card-content">
                            <h:outputText value="Active Budget Lines" styleClass="card-title"/>
                            <h:outputText value="5" styleClass="card-number"/>
                        </div>
                    </div>
                </div>

                <h:panelGroup id="rolesTable" >

                    <div class="search-container">
                        <h3>All Roles</h3>
                        <div class="search-and-filter">
                            <div class="search">
                                <p:inputText id="searchBar2" value="#{userBean.searchQuery}" styleClass="search-bar" placeholder="Search...">
                                    <p:ajax event="keyup" update=":usersForm:rolesTable" listener="#{userBean.searchUsers}"/>
                                </p:inputText>
                            </div>
                        </div>
                    </div>

                    <div class="table-header">
                        <h:outputText value="#{roleBean.roles.size()} Role(s)" styleClass="total-users"/>
                        <div class="table-header-buttons">
                            <p:commandButton icon="pi pi-user-plus" value="Add Role" styleClass="add-button" oncomplete="PF('addRoleDialog').show()" update=":updateRoleForm"/>

                            <p:commandButton icon="pi pi-trash" value="Delete All" action="#" styleClass="delete-all-button">
                                <p:confirm header="Confirm Deletion" message="Do you want to delete all Roles?"
                                           icon="pi pi-info-circle"/>
                            </p:commandButton>
                        </div>
                    </div>

                    <p:dataTable value="#{roleBean.roles}" var="role" paginator="true" rows="5" paginatorPosition="bottom">
                        <p:column headerText="Role Name">
                            <h:outputText value="#{role.name}"/>
                        </p:column>

                        <p:column headerText="Permissions">
                            <h:outputText value="#{role.permissions}"/>
                        </p:column>

                        <p:column headerText="Actions">
                            <p:commandButton value="Edit Role" styleClass="edit-button" action="#{roleBean.selectRole(role)}" oncomplete="PF('editRoleDialog').show();" update=":usersForm:rolesTable :updateRoleForm:editRolePanel" style="font-size: medium !important"/>

                            <p:commandButton value="Delete" action="#{roleBean.deleteRole(role)}" title="Delete" styleClass="delete-button" style="color:red;font-size: medium !important" >
                                <p:confirm header="Confirm Deletion" message="Do you want to delete this Role?"
                                           icon="pi pi-info-circle"/>
                            </p:commandButton>
                        </p:column>

                    </p:dataTable>
                </h:panelGroup>

                <div style="margin-bottom: 20px">

                </div>

                <h:panelGroup id="usersTable" rendered="#{userPermissionBean.hasPermission('VIEW_USERS')}">

                    <div class="search-container">
                        <h3>All users</h3>
                        <div class="search-and-filter">
                            <div class="search">
                                <p:inputText id="searchBar" value="#{userBean.searchQuery}" styleClass="search-bar" placeholder="Search...">
                                    <p:ajax event="keyup" update=":usersForm:usersTable" listener="#{userBean.searchUsers}"/>
                                </p:inputText>
                            </div>
                            <div class="filter">
                                <h:selectOneMenu value="#{userBean.selectedPermission}" styleClass="gender-filter">
                                    <f:selectItem itemLabel="PERMISSION" itemValue="" />
                                    <f:selectItems value="#{userBean.availablePermissions}" var="permission" itemLabel="#{permission}" itemValue="#{permission}" />
                                    <p:ajax event="change" update=":usersForm:usersTable" listener="#{userBean.filterUsersByPermission}"/>
                                </h:selectOneMenu>
                            </div>
                        </div>
                    </div>

                    <div class="table-header">
                        <h:outputText value="#{userBean.users.size()} User(s)" styleClass="total-users"/>
                        <div class="table-header-buttons">
                            <p:commandButton icon="pi pi-user-plus" value="Add User" styleClass="add-button" oncomplete="PF('addUserDialog').show()" rendered="#{userPermissionBean.hasPermission('CREATE_USER')}" update=":addUserForm"/>

                            <p:commandButton icon="pi pi-trash" value="Delete All" action="#" styleClass="delete-all-button" rendered="#{userPermissionBean.hasPermission('DELETE_USER')}">
                                <p:confirm header="Confirm Deletion" message="Do you want to delete all Users?"
                                           icon="pi pi-info-circle"/>
                            </p:commandButton>
                        </div>
                    </div>

                    <p:dataTable value="#{userBean.filteredUsers}" var="user" paginator="true" rows="5" paginatorPosition="bottom">
                        <p:column headerText="User Name">
                            <h:outputText value="#{user.username}"/>
                        </p:column>

                        <p:column headerText="First Name">
                            <h:outputText value="#{user.firstName}"/>
                        </p:column>

                        <p:column headerText="Last Name">
                            <h:outputText value="#{user.lastName}"/>
                        </p:column>

                        <p:column headerText="Email">
                            <h:outputText value="#{user.email}">
                                <f:convertDateTime pattern="dd-MM-yyyy" timeZone="Africa/Kampala"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Phone Number">
                            <h:outputText value="#{user.phoneNumber}">
                                <f:convertDateTime pattern="dd-MM-yyyy" timeZone="Africa/Kampala"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Gender">
                            <h:outputText value="#{user.gender}"/>
                        </p:column>

                        <p:column headerText="Role">
                            <h:outputText value="#{user.role.getName()}"/>
                        </p:column>

                        <p:column headerText="Actions" rendered="#{userPermissionBean.hasPermission('EDIT_USER') and userPermissionBean.hasPermission('DELETE_USER')}">
                            <p:commandButton icon="pi pi-pencil" styleClass="edit-button" action="#{userBean.setSelectedUser(user)}" oncomplete="PF('editUserDialog').show();" update=":usersForm:usersTable " rendered="#{userPermissionBean.hasPermission('EDIT_USER')}"/>

                            <p:commandButton icon="pi pi-trash" action="#{userBean.deleteUser(user)}" title="Delete" styleClass="delete-button" style="color:red" rendered="#{userPermissionBean.hasPermission('DELETE_USER')}">
                                <p:confirm header="Confirm Deletion" message="Do you want to delete this User?"
                                           icon="pi pi-info-circle"/>
                            </p:commandButton>
                        </p:column>

                    </p:dataTable>


                </h:panelGroup>
            </h:form>


        </div>

        <h:form id="addUserForm">
            <p:dialog header="Add New User."
                      widgetVar="addUserDialog"
                      modal="true"
                      resizable="true"
                      showEffect="fade"
                      height="410px"
                      hideEffect="fade"
                      closable="true"
                      width="600px"
                      visible="#{facesContext.validationFailed}">
                <p:outputPanel id="addUserPanel" rendered="true">
                    <p:messages id="addUserPanelMessages" showDetail="false" closable="true" severity="error, info" showSummary="true">
                        <p:autoUpdate/>
                    </p:messages>
                    <p:panelGrid columns="2" styleClass="custom-grid" >

                        <p:outputLabel for="newUserName" value="User Name" >
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="newUserName" value="#{userBean.username}" />
                        </p:outputLabel>

                        <p:outputLabel for="firstName" value="First Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="firstName" value="#{userBean.firstName}" />
                        </p:outputLabel>

                        <p:outputLabel for="lastName" value="Last Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="lastName" value="#{userBean.lastName}" rendered="true"/>
                        </p:outputLabel>

                        <p:outputLabel for="email" value="Email:">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="email" value="#{userBean.email}" rendered="true" />
                        </p:outputLabel>

                        <p:outputLabel for="password" value="Password">
                            <div style="height: 8px">

                            </div>
                            <p:password id="password" value="#{userBean.password}"  />
                        </p:outputLabel>


                        <p:outputLabel for="role" value="Role">
                            <div style="height: 8px">

                            </div>
                            <p:selectOneMenu id="role" value="#{userBean.roleName}"  >
                                <f:selectItem itemLabel="Select Role" itemValue="" />
                                <f:selectItems value="#{userBean.availableRoles}" var="role" itemLabel="#{role}" itemValue="#{role}"/>
                            </p:selectOneMenu>
                        </p:outputLabel>

                        <p:outputLabel for="phone" value="Phone Number">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="phone" value="#{userBean.phoneNumber}"  />
                        </p:outputLabel>

                        <p:outputLabel for="gender" value="Gender">
                            <div style="height: 8px">

                            </div>
                            <p:selectOneMenu id="gender" value="#{userBean.gender}"  >
                                <f:selectItem itemLabel="Select Gender" itemValue="" />
                                <f:selectItems value="#{userBean.availableGenders}" var="gender" itemLabel="#{gender}" itemValue="#{gender}"/>
                            </p:selectOneMenu>
                        </p:outputLabel>


                    </p:panelGrid>

                    <p:commandButton value="Add" update=":usersForm:usersTable" actionListener="#{userBean.registerUser}" icon="pi pi-check" styleClass="add-button"/>
                    <p:commandButton value="Cancel" onclick="PF('addUserDialog').hide();" icon="pi pi-times" styleClass="delete-all-button"/>
                </p:outputPanel>
            </p:dialog>
        </h:form>

        <h:form id="editUserForm">
            <p:dialog header="Update #{userBean.selectedUser.getUsername()}"
                      widgetVar="editUserDialog"
                      modal="true"
                      resizable="true"
                      showEffect="fade"
                      hideEffect="fade"
                      height="410px"
                      closable="true"
                      width="600px"
                      visible="#{facesContext.validationFailed}">
                <p:outputPanel id="editUserPanel" rendered="true">
                    <p:messages id="editUserPanelMessages" showDetail="false" closable="true" severity="error, info" showSummary="true">
                        <p:autoUpdate/>
                    </p:messages>
                    <p:panelGrid columns="2" styleClass="custom-grid">
                        <p:outputLabel for="userName" value="User Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="userName" value="#{userBean.selectedUser.username}" >
                            </p:inputText>
                        </p:outputLabel>


                        <p:outputLabel for="efirstName" value="First Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="efirstName" value="#{userBean.selectedUser.firstName}" >
                            </p:inputText>
                        </p:outputLabel>


                        <p:outputLabel for="elastName" value="Last Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="elastName" value="#{userBean.selectedUser.lastName}" rendered="true">
                            </p:inputText>
                        </p:outputLabel>


                        <p:outputLabel for="eemail" value="Email:">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="eemail" value="#{userBean.selectedUser.email}" >
                            </p:inputText>
                        </p:outputLabel>


                        <p:outputLabel for="epassword" value="Password:">
                            <div style="height: 8px">

                            </div>
                            <p:password id="epassword" value="#{userBean.selectedUser.password}"  />
                        </p:outputLabel>

                        <p:outputLabel for="erole" value="Role:">
                            <div style="height: 8px">

                            </div>
                            <p:selectOneMenu id="erole" value="#{userBean.selectedUser.role.name}"  >
                                <f:selectItem itemLabel="Select Role" itemValue="" />
                                <f:selectItems value="#{userBean.availableRoles}" var="role" itemLabel="#{role}" itemValue="#{role}"/>
                            </p:selectOneMenu>
                        </p:outputLabel>

                        <p:outputLabel for="ephone" value="Phone Number:">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="ephone" value="#{userBean.selectedUser.phoneNumber}"  />
                        </p:outputLabel>

                        <p:outputLabel for="egender" value="Gender:">
                            <div style="height: 8px">

                            </div>
                            <p:selectOneMenu id="egender" value="#{userBean.selectedUser.gender}"  >
                                <f:selectItem itemLabel="Select Gender" itemValue="" />
                                <f:selectItems value="#{userBean.availableGenders}" var="gender" itemLabel="#{gender}" itemValue="#{gender}"/>
                            </p:selectOneMenu>
                        </p:outputLabel>


                    </p:panelGrid>

                    <p:commandButton value="Update" update=":usersForm:usersTable" actionListener="#{userBean.updateUser}" icon="pi pi-check" styleClass="add-button"/>
                    <p:commandButton value="Cancel" onclick="PF('addUserDialog').hide();" icon="pi pi-times" styleClass="delete-all-button"/>
                </p:outputPanel>
            </p:dialog>
        </h:form>

        <h:form id="addRoleForm">
            <p:dialog header="Add New Role."
                      widgetVar="addRoleDialog"
                      modal="true"
                      resizable="true"
                      height="400px"
                      showEffect="fade"
                      hideEffect="fade"
                      closable="true"
                      width="800px"
                      visible="#{facesContext.validationFailed}">
                <p:outputPanel id="addRolePanel" rendered="true">
                    <p:messages id="addRolePanelMessages" showDetail="false" closable="true" severity="error, info" showSummary="true">
                        <p:autoUpdate/>
                    </p:messages>
                    <p:panelGrid columns="2" styleClass="custom-grid">
                        <p:outputLabel for="roleName" value="Role Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="roleName" value="#{roleBean.roleName}" >
                            </p:inputText>
                        </p:outputLabel>


                        <h:outputLabel for="permissions" value="Select Permissions">
                            <div style="height: 8px">

                            </div>
                            <p:selectManyCheckbox id="permissions" value="#{roleBean.selectedPermissions}" layout="grid" columns="1" style="height: 100px; overflow-y: scroll;">
                                <f:selectItems value="#{roleBean.availablePermissions}" var="permission" itemLabel="#{permission}" itemValue="#{permission}"/>
                            </p:selectManyCheckbox>
                        </h:outputLabel>


                    </p:panelGrid>

                    <p:commandButton value="Add" onclick="PF('addRoleDialog').hide();" update=":usersForm:rolesTable" actionListener="#{roleBean.createRole()}" icon="pi pi-check" styleClass="add-button"/>
                    <p:commandButton value="Cancel" onclick="PF('addRoleDialog').hide();" icon="pi pi-times" styleClass="delete-all-button" />
                </p:outputPanel>
            </p:dialog>
        </h:form>

        <h:form id="updateRoleForm">
            <p:dialog header="Update Role"
                      widgetVar="editRoleDialog"
                      modal="true"
                      resizable="true"
                      showEffect="fade"
                      hideEffect="fade"
                      closable="true"
                      height="400px"
                      width="800px"
                      visible="#{facesContext.validationFailed}">
                <p:outputPanel id="editRolePanel" rendered="true">
                    <p:messages id="editRolePanelMessages" showDetail="false" closable="true" severity="error, info" showSummary="true">
                        <p:autoUpdate/>
                    </p:messages>
                    <p:panelGrid columns="2" styleClass="custom-grid">
                        <p:outputLabel for="eroleName" value="Role Name">
                            <div style="height: 8px">

                            </div>
                            <p:inputText id="eroleName" value="#{roleBean.selectedRole.name}" />
                        </p:outputLabel>

                        <h:outputLabel for="epermissions" value="Select Permissions">
                            <div style="height: 8px">

                            </div>
                            <p:selectManyCheckbox id="epermissions" value="#{roleBean.updateSelectedPermissions}" layout="grid" columns="1" style="height: 100px; overflow-y: scroll;">
                                <f:selectItems value="#{roleBean.availablePermissions}" var="permission" itemLabel="#{permission}" itemValue="#{permission}"/>
                            </p:selectManyCheckbox>
                        </h:outputLabel>

                    </p:panelGrid>

                    <p:commandButton value="Update" update=":usersForm:rolesTable @form" actionListener="#{roleBean.updateRole}" icon="pi pi-check" styleClass="add-button" oncomplete="PF('editRoleDialog').hide();"/>
                    <p:commandButton value="Cancel" onclick="PF('editRoleDialog').hide();" icon="pi pi-times" styleClass="delete-all-button" immediate="true" />
                </p:outputPanel>
            </p:dialog>
        </h:form>

    </ui:define>

</ui:composition>